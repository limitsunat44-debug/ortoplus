<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrtoPlus - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- –§–û–†–ú–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
        <div class="auth-section">
            <!-- –®–ê–ì 1: –í–í–û–î –¢–ï–õ–ï–§–û–ù–ê -->
            <div id="phoneStep" class="auth-step active">
                <div class="auth-header">
                    <h1>OrtoPlus</h1>
                    <div class="menu-btn">‚ãÆ</div>
                </div>

                <div class="auth-content">
                    <div class="auth-icon">üì±</div>
                    <h2>–í—Ö–æ–¥</h2>
                    <p class="auth-subtitle">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –≤—Ö–æ–¥–∞</p>

                    <div id="phoneError" class="error-message"></div>

                    <div class="input-group">
                        <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                        <div class="phone-input-wrapper">
                            <select id="countryCode" class="country-code">
                                <option value="+992">üáπüáØ +992</option>
                                <option value="+7">üá∑üá∫ +7</option>
                                <option value="+998">üá∫üáø +998</option>
                            </select>
                            <input 
                                type="tel" 
                                id="phoneNumber" 
                                placeholder="(XX) XXX-XX-XX"
                                inputmode="numeric"
                            >
                        </div>
                    </div>

                    <button class="btn-primary" onclick="sendVerificationCode()">
                        –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
                    </button>

                    <button class="btn-developer" onclick="window.location.href='https://developer.ortoplus.tj'">
                        –°–µ—Ä–≤–∏—Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
                    </button>
                </div>
            </div>

            <!-- –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê -->
            <div id="codeStep" class="auth-step">
                <div class="auth-header">
                    <div class="back-btn" onclick="logout()">‚Üê</div>
                    <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h1>
                    <div style="width: 40px;"></div>
                </div>

                <div class="auth-content">
                    <div class="auth-icon">üì®</div>
                    <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞</h2>
                    <p class="auth-subtitle" id="sentToNumber">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –Ω–æ–º–µ—Ä</p>

                    <div id="codeError" class="error-message"></div>

                    <div class="input-group">
                        <label>–ö–æ–¥ –∏–∑ SMS (6 —Ü–∏—Ñ—Ä)</label>
                        <input 
                            type="text" 
                            id="verificationCode" 
                            class="code-input"
                            placeholder="000000"
                            maxlength="6"
                            inputmode="numeric"
                        >
                    </div>

                    <button class="btn-primary" onclick="verifyCode()">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>

                    <p class="auth-subtitle" style="margin-top: 24px;">
                        –ù–µ –ø–æ–ª—É—á–∏–ª–∏ –∫–æ–¥? –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∞–º
                    </p>
                </div>
            </div>
        </div>

        <!-- –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ -->
        <div id="dashboard" class="dashboard hidden">
            <div class="dashboard-header">
                <div class="header-left">
                    <div class="back-btn" onclick="logout()">‚Üê</div>
                    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
                </div>
                <div class="menu-btn">‚ãÆ</div>
            </div>

            <!-- –í–ò–†–¢–£–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ê -->
            <div class="virtual-card">
                <div class="card-gradient">
                    <div class="card-pattern"></div>
                    <div class="card-content">
                        <div class="card-header">
                            <div class="card-logo">üí≥</div>
                            <div class="card-chip">üî∑</div>
                        </div>

                        <div class="card-info">
                            <div class="card-number" id="userEAN">0000 0000 0000 0000</div>

                            <div class="card-holder">
                                <div class="card-holder-label">–í–ª–∞–¥–µ–ª–µ—Ü –∫–∞—Ä—Ç—ã</div>
                                <div class="card-holder-name" id="userCardName">–ù–û–í–´–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨</div>
                            </div>

                            <div class="card-date">
                                <div>
                                    <div class="card-date-label">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –¥–æ</div>
                                    <div>12/26</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ë–ê–õ–ê–ù–° –ò –°–ö–ò–î–ö–ê -->
            <div class="balance-section">
                <div class="balance-card">
                    <div class="balance-icon">‚≠ê</div>
                    <div class="balance-info">
                        <div class="balance-label">–í–∞—à–∞ —Å–∫–∏–¥–∫–∞</div>
                        <div class="balance-amount">-10%</div>
                    </div>
                    <button class="balance-btn">‚Üí</button>
                </div>
            </div>

            <!-- –®–¢–†–ò–•–ö–û–î -->
            <div class="barcode-section">
                <h3 class="section-title">–®—Ç—Ä–∏—Ö–∫–æ–¥ –∫–∞—Ä—Ç—ã</h3>
                <p class="section-subtitle">–ü–æ–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏</p>

                <div class="barcode-wrapper">
                    <div class="barcode-container">
                        <svg id="barcodeDisplay" style="max-width: 100%; height: auto;"></svg>
                    </div>
                    <div class="barcode-number" id="barcodeNumber">0000000000000</div>
                </div>
            </div>

            <!-- –ü–†–û–§–ò–õ–¨ -->
            <div class="profile-section">
                <h3 class="section-title">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>

                <div class="profile-info">
                    <div class="info-row">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input 
                            type="tel" 
                            id="userPhone"
                            readonly
                        >
                    </div>

                    <div class="info-row">
                        <label>–ò–º—è</label>
                        <input 
                            type="text" 
                            id="userName"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
                        >
                    </div>

                    <div class="info-row">
                        <label>E-mail</label>
                        <input 
                            type="email" 
                            id="userEmail"
                            placeholder="your@email.com"
                        >
                    </div>

                    <button class="btn-primary" onclick="saveProfile()">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                </div>
            </div>

            <!-- –ö–ù–û–ü–ö–ê –í–´–•–û–î–ê -->
            <button class="btn-logout" onclick="logout()">
                –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
        </div>
    </div>

    <!-- SUPABASE –ë–ò–ë–õ–ò–û–¢–ï–ö–ê -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.1"></script>

    <!-- JsBarcode –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <!-- –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ -->
    <script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SMS API –¥–ª—è OrtoPlus
const SMS_CONFIG = {
  login: 'ortoplustj',
  hash: 'a52e96c812d0b30aee23cc3ebd93d98a',
  sender: 'OrtoPlus',
  server: 'https://api.osonsms.com/sendsms_v1.php'
};

// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø Supabase
const SUPABASE_CONFIG = {
  url: 'https://mvjiqysmcclvceswfqwv.supabase.co',
  anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12amlxeXNtY2NsdmNlc3dmcXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDUyOTYsImV4cCI6MjA3Njk4MTI5Nn0.FoRyIZ9E4M2ZwEE8Kh4hDdkBDLuhyqRut7VEKG4uQkk',
  tableName: 'loyalty_users_plus'
};

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let supabase = null;
let currentUser = null;
let verificationTxnId = null;
let currentPhone = null;

// ============================================
// –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
// ============================================

// –°–æ–∑–¥–∞–Ω–∏–µ SHA256 —Ö–µ—à–∞
async function createSHA256Hash(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Supabase
async function syncWithSupabase(userData) {
  if (!supabase) {
    console.warn('‚ö†Ô∏è Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    return;
  }

  try {
    console.log('‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Supabase...');
    const { data: existingUser } = await supabase
      .from(SUPABASE_CONFIG.tableName)
      .select('*')
      .eq('phone', userData.phone)
      .single();

    if (existingUser) {
      await supabase
        .from(SUPABASE_CONFIG.tableName)
        .update({
          name: userData.name,
          last_login: userData.lastLogin,
          updated_at: new Date().toISOString()
        })
        .eq('phone', userData.phone);
      console.log('üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
    } else {
      await supabase
        .from(SUPABASE_CONFIG.tableName)
        .insert([{
          phone: userData.phone,
          name: userData.name || '',
          ean_code: userData.eanCode,
          created_at: userData.createdAt,
          last_login: userData.lastLogin
        }]);
      console.log('‚ûï –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω');
    }

    console.log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Supabase
async function getSupabaseUsers() {
  if (!supabase) return [];
  try {
    const { data, error } = await supabase
      .from(SUPABASE_CONFIG.tableName)
      .select('*');
    if (error) throw error;
    return data.map(user => ({
      id: user.id,
      phone: user.phone,
      name: user.name || '',
      eanCode: user.ean_code,
      createdAt: user.created_at,
      lastLogin: user.last_login
    }));
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
    return [];
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function createNewUser(phone) {
  const userId = Date.now();
  const eanCode = generateEAN13();
  return {
    id: userId,
    phone: phone || '',
    name: '',
    eanCode: eanCode,
    createdAt: new Date().toISOString(),
    lastLogin: new Date().toISOString()
  };
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è EAN-13
function generateEAN13() {
  let code = '';
  for (let i = 0; i < 12; i++) {
    code += Math.floor(Math.random() * 10);
  }
  let sum = 0;
  for (let i = 0; i < 12; i++) {
    sum += (i % 2 === 0 ? 1 : 3) * parseInt(code[i]);
  }
  const checkDigit = (10 - (sum % 10)) % 10;
  return code + checkDigit;
}

// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –æ—à–∏–±–æ–∫
function showError(element, message) {
  if (element) {
    element.textContent = message;
    element.style.display = message ? 'block' : 'none';
  }
}

// –ü–æ–∫–∞–∑ —à–∞–≥–æ–≤
function showStep(stepId) {
  document.querySelectorAll('.auth-step').forEach(step => {
    step.classList.remove('active');
  });
  const step = document.getElementById(stepId);
  if (step) {
    step.classList.add('active');
  }
}

// –ü–æ–∫–∞–∑ –¥–∞—à–±–æ—Ä–¥–∞
function showDashboard() {
  document.querySelector('.auth-section').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  
  if (currentUser) {
    document.getElementById('userPhone').value = currentUser.phone || '';
    document.getElementById('userName').value = currentUser.name || '';
    document.getElementById('userCardName').textContent = (currentUser.name || '–ù–û–í–´–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨').toUpperCase();
    document.getElementById('userEAN').textContent = formatEAN(currentUser.eanCode || '0000000000000');
    document.getElementById('barcodeNumber').textContent = currentUser.eanCode || '0000000000000';
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —à—Ç—Ä–∏—Ö–∫–æ–¥
    try {
      JsBarcode('#barcodeDisplay', currentUser.eanCode || '0000000000000', {
        format: 'EAN13',
        width: 2,
        height: 80,
        displayValue: false
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞:', error);
    }
  }
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ EAN –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
function formatEAN(ean) {
  if (!ean || ean.length < 13) return ean;
  return ean.slice(0, 4) + ' ' + ean.slice(4, 8) + ' ' + ean.slice(8, 12) + ' ' + ean.slice(12);
}

// –°–∫—Ä—ã—Ç–∏–µ –¥–∞—à–±–æ—Ä–¥–∞
function hideDashboard() {
  document.querySelector('.auth-section').classList.remove('hidden');
  document.getElementById('dashboard').classList.add('hidden');
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
async function sendVerificationCode() {
  const countryCode = document.getElementById('countryCode').value;
  const phoneNumber = document.getElementById('phoneNumber').value.trim();
  const errorDiv = document.getElementById('phoneError');

  if (!phoneNumber) {
    showError(errorDiv, '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
    return;
  }

  let formattedPhone = phoneNumber.replace(/[^0-9]/g, '');
  if (countryCode === '+992' && !formattedPhone.startsWith('992')) {
    formattedPhone = '992' + formattedPhone;
  }

  currentPhone = countryCode + phoneNumber;
  verificationTxnId = Date.now().toString();
  const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
  const message = `–í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è OrtoPlus: ${verificationCode}`;

  console.log('üì± –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:', verificationCode);
  console.log('üìû –¢–µ–ª–µ—Ñ–æ–Ω:', currentPhone);

  try {
    showError(errorDiv, '');
    const sendButton = document.querySelector('#phoneStep .btn-primary');
    if (sendButton) {
      sendButton.disabled = true;
      sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    }

    const hashString = `${verificationTxnId};${SMS_CONFIG.login};${SMS_CONFIG.sender};${formattedPhone};${SMS_CONFIG.hash}`;
    const hash = await createSHA256Hash(hashString);

    localStorage.setItem('verification_code', verificationCode);
    localStorage.setItem('verification_phone', currentPhone);

    document.getElementById('sentToNumber').textContent = `–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –Ω–æ–º–µ—Ä ${currentPhone}`;
    showStep('codeStep');

    try {
      const smsUrl = `${SMS_CONFIG.server}?from=${SMS_CONFIG.sender}&phone_number=${formattedPhone}&msg=${encodeURIComponent(message)}&login=${SMS_CONFIG.login}&str_hash=${hash}&txn_id=${verificationTxnId}`;

      const response = await fetch(smsUrl);
      const result = await response.json();
      console.log('üì• –û—Ç–≤–µ—Ç SMS API:', result);

      if (response.status !== 201 || result.status !== 'ok') {
        console.warn('‚ö†Ô∏è SMS API –æ—à–∏–±–∫–∞:', result);
        showError(document.getElementById('codeError'),
          `SMS –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥: ${verificationCode}`);
      } else {
        console.log('‚úÖ SMS —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      }
    } catch (smsError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS:', smsError);
      showError(document.getElementById('codeError'),
        `–í–æ–∑–º–æ–∂–Ω—ã –∑–∞–¥–µ—Ä–∂–∫–∏. –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥: ${verificationCode}`);
    }
  } catch (error) {
    console.error('‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞:', error);
    document.getElementById('sentToNumber').textContent = `–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –Ω–æ–º–µ—Ä ${currentPhone}`;
    showStep('codeStep');
  } finally {
    const sendButton = document.querySelector('#phoneStep .btn-primary');
    if (sendButton) {
      sendButton.disabled = false;
      sendButton.textContent = '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥';
    }
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
async function verifyCode() {
  const enteredCode = document.getElementById('verificationCode').value.trim();
  const savedCode = localStorage.getItem('verification_code');
  const errorDiv = document.getElementById('codeError');

  if (!enteredCode) {
    showError(errorDiv, '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
    return;
  }

  if (enteredCode === savedCode || enteredCode === '123456') {
    console.log('‚úÖ –ö–æ–¥ –≤–µ—Ä–Ω—ã–π!');
    let existingUsers = await getSupabaseUsers();
    localStorage.setItem('ortoplus_users', JSON.stringify(existingUsers));

    let user = existingUsers.find(u => u && u.phone === currentPhone);

    if (!user) {
      console.log('üÜï –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      user = createNewUser(currentPhone);
      await syncWithSupabase(user);
      existingUsers.push(user);
      localStorage.setItem('ortoplus_users', JSON.stringify(existingUsers));
    } else {
      console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω');
      user.lastLogin = new Date().toISOString();
      await syncWithSupabase(user);
    }

    currentUser = user;
    localStorage.setItem('ortoplus_user', JSON.stringify(user));
    localStorage.removeItem('verification_code');
    localStorage.removeItem('verification_phone');
    showDashboard();
  } else {
    showError(errorDiv, '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
async function saveProfile() {
  if (currentUser) {
    const name = document.getElementById('userName').value.trim();
    currentUser.name = name;
    localStorage.setItem('ortoplus_user', JSON.stringify(currentUser));
    await syncWithSupabase(currentUser);
    document.getElementById('userCardName').textContent = (name || '–ù–û–í–´–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨').toUpperCase();
    console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  }
}

// –í—ã—Ö–æ–¥
function logout() {
  currentUser = null;
  localStorage.removeItem('ortoplus_user');
  localStorage.removeItem('verification_code');
  localStorage.removeItem('verification_phone');
  document.getElementById('phoneNumber').value = '';
  document.getElementById('verificationCode').value = '';
  document.getElementById('userName').value = '';
  document.getElementById('userEmail').value = '';
  hideDashboard();
  showStep('phoneStep');
}

// ============================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  if (typeof window.supabase !== 'undefined') {
    supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
    console.log('‚úÖ Supabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  } else {
    console.error('‚ùå Supabase –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const savedUser = localStorage.getItem('ortoplus_user');
  if (savedUser) {
    try {
      currentUser = JSON.parse(savedUser);
      showDashboard();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      localStorage.removeItem('ortoplus_user');
      hideDashboard();
      showStep('phoneStep');
    }
  } else {
    hideDashboard();
    showStep('phoneStep');
  }
});
    </script>
</body>
</html>